# ptpm-app — Peter the Possum Man Ontraport App

## Project Details
- **Client:** Peter the Possum Man (slug: `peterpm`)
- **Type:** Ontraport App (vanilla JS, no build step)
- **GitHub Pages:** https://itmooti-codex.github.io/ptpm-app
- **VitalSync SDK:** Loaded via CDN in header code
- **Script Load Order:** config.js → utils.js → models.js → vitalsync.js → app.js

## Quick Commands
- `npm run dev` — Start local dev server at **http://localhost:8000/dev/**
- `npm run parse-schema` — Re-generate types + schema reference from schema.xml

<!-- GOTCHAS:START — Auto-synced from VibeCodeApps. Do not edit manually. -->

These are the most important gotchas — memorize these to avoid common bugs:

- **`plugin.switchTo()` needs the INTERNAL prefixed name** (e.g. `ThcContact`), NOT `publicName` (`Contact`). The `publicName` is for UI labels and TypeScript type names only.
- **Always `.pipe(window.toMainInstance(true))`** on all `fetchAllRecords()` / `fetchOneRecord()` queries
- **SDK records have NON-ENUMERABLE properties** — `{ ...record }` and `Object.keys(record)` produce `{}` / `[]`. Use `record.getState()` to get a plain JS object with all properties. Critical for MUI DataGrid which needs enumerable `id` field.
- **Records are immutable** — never `Object.assign(record, data)` or `record.field = value`, always spread `{ ...existingData, ...newData }`
- **Subscription payloads are PLAIN objects** (no `getState()`), do NOT include `id`, and have `null`/`undefined` for unchanged fields — never blind-merge, only merge defined non-null values, and always preserve the known `id`
- **Mutations disrupt subscriptions** — after `mutation.execute()`, clean up and re-subscribe
- **MUI DataGrid editable columns should NOT use `valueGetter`** — it interferes with the edit mechanism
- **`import 'dotenv/config'` MUST be the first import** in Express server entry points
- **Express MUST bind `0.0.0.0`** (not `127.0.0.1`) for Docker and mobile access
- **Direct GraphQL `fetch()` is an alternative to SDK for complex queries** — useful for calc/aggregation queries, cross-model joins, `orderBy`, and `field()` aliasing. The SDK query builder *does* support calc queries; past failures were due to invalid field references, not SDK limitations.
- **VitalSync SDK rejects `capacitor://localhost` origin** — must set `server.url` in capacitor config to a real HTTP/HTTPS URL
- **Keep `.limit()` reasonable** — limits above ~1,000 can cause the SDK to hang. Use pagination instead.
- **Ontraport Vite dev server**: root: `.` with `open: '/dev/'` — NOT `root: 'dev'` which breaks `../src/` paths
<!-- GOTCHAS:END -->

## Reference Docs

Read these files on demand when working on the corresponding task:

- **`docs/vitalsync-sdk-patterns.md`** — VitalSync queries, subscriptions, mutations, direct GraphQL API, record conversion
- **`docs/ontraport-app-workflow.md`** — Ontraport scaffolding workflow, merge fields, dynamic lists, config bridge
- **`docs/deployment.md`** — GitHub Pages deployment, cache busting, GitHub Actions
- **`docs/schema-format.md`** — Schema XML parsing reference, data types, enums, FKs
- **`docs/research-phase.md`** — Research script, data collectors, knowledge base

## Schema Workflow
1. Export schema XML from VitalStats and place at `schema/schema.xml`
2. Run `npm run parse-schema`
3. This generates:
   - `src/types/models.js` — JSDoc typedefs + MODELS metadata
   - `schema/schema-reference.json` — Full parsed schema reference
   - Updates the Schema Reference section below

## Reusable Feature Patterns

Check `docs/features/` for pre-built feature implementations that can be added to this app. Each file documents a complete feature with architecture, file list, dependencies, and implementation steps.

## Feature Contribution

When you build a significant new reusable feature in this app (e.g., a new integration, a complex UI pattern, a data pipeline), **proactively offer to document it** for reuse in future projects:

1. Create a feature doc in `docs/features/` following the template in `docs/features/README.md`
2. Include: architecture overview, all files involved, dependencies, env vars, gotchas
3. Tell the user: *"This feature could benefit other projects. I've documented it in `docs/features/`. You can contribute it back to VibeCodeApps by copying it to `../VibeCodeApps/docs/features/` and running `./scripts/sync-child.sh --all`."*

## Staying Current

This project's docs were synced from VibeCodeApps on the date in `docs/.sync-version`. If the parent project has been updated (new features, fixed gotchas, improved patterns), the user can re-sync:
```bash
cd ../VibeCodeApps && ./scripts/sync-child.sh ../ptpm-app
```

<!-- SCHEMA:START — Auto-generated by parse-schema. Do not edit manually. -->
_Run `npm run parse-schema` after importing schema.xml to populate this section._
<!-- SCHEMA:END -->

<!-- RESEARCH:START — Auto-generated by research.cjs. Do not edit manually. -->
_Run the research script to populate this section with business intelligence._
<!-- RESEARCH:END -->
